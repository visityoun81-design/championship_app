<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CHAMPIONSHIP MASTER FINAL</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@900&family=Orbitron:wght@700&display=swap" rel="stylesheet">


    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="dog.png">

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js');
  }
</script>


    <style>
        :root { --bg: #000; --purple: #c084fc; --green: #4ade80; --red: #f87171; --bead: #4ade80; --bar-top: 100px; --gold: #fbbf24; }
        body { margin: 0; background: var(--bg); color: #fff; font-family: 'Noto Sans KR', sans-serif; display: flex; height: 100vh; width: 100vw; overflow: hidden; touch-action: none; -webkit-user-select: none; user-select: none; flex-direction: row; }
        
        #left-panel { width: 130px; background: #0a0a0a; border-right: 1px solid #222; flex-shrink: 0; display: flex; flex-direction: column; padding: 8px; font-size: 0.8rem; position: relative; }
        
        /* ê³¼ì • í‘œì‹œ ìŠ¤íƒ€ì¼: ì´ˆê¸‰ íŒŒë€ìƒ‰ */
        #course-title {
            background: #4ea8de; 
            color: #fff;
            font-weight: 900;
            text-align: center;
            padding: 5px;
            border-radius: 5px;
            margin-bottom: 5px;
            font-size: 0.85rem;
        }

        #timer-display { font-family: 'Orbitron', sans-serif; font-size: 1.1rem; color: var(--red); text-align: center; margin-bottom: 8px; border: 1px solid var(--red); padding: 4px; border-radius: 5px; background: rgba(248, 113, 113, 0.05); }
        #reversal-notice { background: var(--purple); color: white; padding: 4px 8px; border-radius: 10px; font-size: 0.65rem; font-weight: 900; text-align: center; margin-bottom: 8px; display: none; box-shadow: 0 0 10px var(--purple); }
        #step-info { color: var(--purple); font-family: 'Orbitron'; text-align: center; margin-bottom: 10px; font-weight: 900; }
        .log-btn { width: 100%; background: #1a1a1a; color: var(--gold); border: 1px solid var(--gold); padding: 8px; font-size: 0.75rem; border-radius: 6px; font-weight: 900; cursor: pointer; margin-bottom: 10px; transition: all 0.2s; }
        .log-btn:hover { background: var(--gold); color: #000; }

        #hall-of-fame { flex: 1; overflow-y: auto; margin-bottom: 8px; scrollbar-width: none; }
        #hall-of-fame::-webkit-scrollbar { width: 4px; }
        #hall-of-fame::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }

        .rank-item { display: flex; justify-content: space-between; align-items: center; padding: 4px 6px; margin-bottom: 3px; border-radius: 3px; font-size: 0.65rem; font-weight: 900; color: #000; transition: all 0.3s; position: relative; }
        .color-1 { background: #ffd700; } .color-2 { background: #ff85a2; } .color-3 { background: #4ea8de; } .color-4 { background: #9d4edd; } .color-5 { background: #ff9100; } .color-other { background: var(--green); }
        
        /* í™”ë ¤í•œ ë¬´ì§€ê°œ ë°˜ì§ì´ íš¨ê³¼ (ì¤‘ê¸‰ê³¼ ë™ì¼) */
        .is-playing { 
            animation: rainbow-super-shine 0.6s infinite alternate; 
            position: relative;
            border: 2px solid #fff !important;
            transform: scale(1.05); 
            z-index: 5;
        }
        .is-playing::after { 
            content: "âš¡"; 
            position: absolute; 
            right: 20px; 
            font-size: 1rem; 
            text-shadow: 0 0 5px white;
            animation: thunder-bolt 0.3s infinite alternate; 
        }

        @keyframes rainbow-super-shine { 
            0% { box-shadow: 0 0 5px #ff0000, inset 0 0 5px #ff0000; filter: brightness(1.2); } 
            33% { box-shadow: 0 0 7px #00e1ff, inset 0 0 5px #00e1ff; filter: brightness(1.3); }
            66% { box-shadow: 0 0 10px #ffea00, inset 0 0 5px #ffea00; filter: brightness(1.4); }
            100% { box-shadow: 0 0 13px #ff00ff, inset 0 0 5px #ff00ff; filter: brightness(1.5); } 
        }

        @keyframes thunder-bolt { from { transform: scale(1); opacity: 0.7; } to { transform: scale(1.3); opacity: 1; } }

/* í° ë²ˆê°œ ë°˜ì§ì„ ì• ë‹ˆë©”ì´ì…˜ */
@keyframes flash {
    from { opacity: 1; transform: scale(1); }
    to { opacity: 0.5; transform: scale(1.2); }
}
        @keyframes trophy-bounce { from { transform: translateY(0); } to { transform: translateY(-3px); } }

        /* ì—­ì „ ì•Œë¦¼ì´ ë¶€ë“œëŸ½ê²Œ ë‚˜íƒ€ë‚¬ë‹¤ ì‚¬ë¼ì§€ëŠ” íš¨ê³¼ */
        @keyframes fade-up { 0% { opacity: 0; transform: translateY(5px); } 20% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-5px); } }

        .my-record { border: 3px solid #ff0000 !important; box-shadow: 0 0 15px #ff0000; z-index: 10; }

        .crown-icon { display: inline-block; margin-left: 5px; font-size: 1rem; filter: drop-shadow(0 0 2px rgba(0,0,0,0.8)); animation: trophy-bounce 0.8s infinite alternate; vertical-align: middle; }


        #center-game { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; overflow: hidden; }

        #display-main { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; z-index: 10; flex-direction: column; font-size: 5.0rem; font-weight: 900; position: relative; }
        
        /* ê²Œì‹œì•”ì‚° í¬ê¸° ë° ê°„ê²© ë³µêµ¬ */
        .board-list { line-height: 1.1; color: var(--green); text-align: center; letter-spacing: 2px; display: flex; flex-direction: column; align-items: center; width: 100%; }
        .board-rows-234 { font-size: 3.0rem; }
        .board-rows-5 { font-size: 2.8rem; }
        .board-rows-7 { font-size: 2.7rem; }
        
        .rolling-num { position: absolute; font-weight: 900; font-size: 3.2rem; color: var(--green); animation: continuousRoll var(--roll-dur, 2000ms) linear forwards; }
        @keyframes continuousRoll { 0% { transform: translateY(40vh); opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { transform: translateY(-40vh); opacity: 0; } }
        
        #feedback-area { position: absolute; left: 8%; top: 50%; transform: translateY(-50%); z-index: 2000; pointer-events: none; }
        #feedback-icon { font-size: 5rem; font-weight: 900; display: none; }
        .correct { color: #4ade80 !important; text-shadow: 0 0 25px #4ade80; }
        .wrong { color: #f87171 !important; text-shadow: 0 0 20px #f87171; }
        
        .abacus-frame { display: flex; gap: 4px; position: relative; padding: 10px 15px; border: 8px solid #3d2b1f; border-radius: 8px; background: #000; height: 280px; }
        .master-divider { position: absolute; top: var(--bar-top); left: 0; width: 100%; height: 10px; background: #ddd; z-index: 15; }
        .column { position: relative; width: 46px; height: 100%; display: flex; flex-direction: column; align-items: center; }
        .rod { width: 4px; height: 100%; background: #444; position: absolute; left: 50%; transform: translateX(-50%); }
        .bead { width: 46px; height: 32px; background: radial-gradient(circle at 50% 30%, #66ef96 0%, #4ade80 40%, #2d8a50 100%); border-radius: 40% / 50%; border: 1px solid #1a5c34; position: absolute; z-index: 10; }
        
        #right-keypad { width: 280px; background: #0d0d0d; border-left: 1px solid #222; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        #display-answer { background: #fff; height: 60px; border-radius: 8px; color: #000; font-size: 2.5rem; display: flex; align-items: center; justify-content: center; font-weight: 900; border: 4px solid var(--purple); margin-bottom: 5px; }
        .key { background: #2a2a2a; color: #fff; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; border-radius: 10px; cursor: pointer; box-shadow: 0 4px #000; font-weight: 900; }
        
        #schulte-overlay { position: fixed; inset: 0; background: #000; z-index: 15000; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 10px; box-sizing: border-box; }
        .game-header { display: flex; flex-direction: column; align-items: center; gap: 5px; margin-bottom: 5px; margin-top: -30px; width: 100%; z-index: 17000; }
        #game-target-msg { color: var(--gold); font-size: 1.1rem; font-weight: 900; background: rgba(0,0,0,0.8); padding: 4px 15px; border-radius: 20px; border: 1px solid var(--gold); margin-bottom: 5px; }
        #schulte-timer-container { width: 220px; height: 12px; background: #333; border-radius: 6px; overflow: hidden; border: 1px solid #555; }
        #schulte-timer-bar { width: 100%; height: 100%; background: var(--purple); }
        .schulte-grid { display: grid; gap: 8px; width: 90vw; max-width: 380px; max-height: 60vh; aspect-ratio: 1 / 1; }
        .schulte-cell { background: #1a1a1a; border: 2px solid #444; color: #fff; display: flex; align-items: center; justify-content: center; font-size: clamp(1.2rem, 6vw, 2.2rem); font-weight: 900; border-radius: 10px; cursor: pointer; }
        
        #block-container { position: absolute; inset: 0; display: none; background: #000; overflow: hidden; z-index: 16000; }
        .block { position: absolute; width: 60px; height: 60px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; font-weight: 900; color: #fff; cursor: pointer; z-index: 16500; border: 1px solid rgba(255,255,255,0.3); transition: top 1.2s ease-in; }

        #schulte-msg { position: absolute; inset: 0; display: none; align-items: center; justify-content: center; z-index: 18000; background: #000; }
        .result-card { background: rgba(15, 15, 15, 0.98); border-radius: 20px; border: 3px solid var(--purple); text-align: center; padding: 20px; box-shadow: 0 0 40px rgba(192, 132, 252, 0.4); width: 90%; max-width: 450px; margin: auto; }
        
         /* ì—°ìŠµê¸°ë¡ í•­ëª©ì„ ì´˜ì´˜í•˜ê³  ì˜ˆì˜ê²Œ ìˆ˜ì • */
.history-item { 
    display: grid; 
    grid-template-columns: 1.2fr 0.8fr 0.8fr 0.5fr; /* ë‚ ì§œ / ì—°ìŠµì‹œê°„ / ì†Œìš”ì‹œê°„ / ì ìˆ˜ */
    align-items: center; 
    background: #1a1a1a; 
    padding: 4px 8px; /* ê°„ê²©ì„ ì¢ê²Œ ì¡°ì • */
    margin-bottom: 2px; /* í•­ëª© ì‚¬ì´ í‹ˆì„ ìµœì†Œí™” */
    border-radius: 4px; 
    font-size: 0.65rem; 
    border-left: 3px solid var(--gold); 
    border-bottom: 1px solid #222;
}

.history-item .log-date { color: #888; }
.history-item .log-time { color: #aaa; text-align: center; }
.history-item .log-duration { color: var(--purple); text-align: center; }
.history-item .log-score { color: var(--gold); font-weight: 900; text-align: right; font-size: 0.75rem; }
        
#history-popup { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 25000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .close-x:hover { color: var(--red); }

@media (orientation: portrait) { 
    body { flex-direction: column; } 
    #left-panel { display: none !important; } 
    #right-keypad { 
        width: 100% !important; 
        height: 42% !important; /* ë‹¤ì‹œ ê¸°ì¡´ ìˆ˜ì¹˜ë¡œ ë³µêµ¬í•˜ì—¬ ì°Œë¶€ëœ ëª¨ì–‘ì„ í•´ê²°í•©ë‹ˆë‹¤ */
        border-top: 1px solid #222; 
        padding: 10px !important; 
        box-sizing: border-box; 
    } 
    #center-game { flex: 1; width: 100%; height: auto; } 
    #display-answer { 
        width: 90% !important; 
        /* ë‹µì•ˆ ì¹¸ì´ ì‘ì•„ì¡Œë‹¤ë©´ height ìˆ˜ì¹˜ë¥¼ ë‹¤ì‹œ í™•ì¸í•´ ì£¼ì„¸ìš” (ê¸°ë³¸ì€ flexì— ì˜í•´ ê²°ì •ë˜ê±°ë‚˜ ì•½ 60px) */
        height: 60px !important; 
        margin: 0 auto 10px auto !important; 
    } 
    .abacus-frame { transform: scale(0.75) !important; }
}

@media (orientation: landscape) {
    /* ê°€ë¡œ ëª¨ë“œì—ì„œ í‚¤ë³´ë“œì˜ ì„¸ë¡œ ë†’ì´ê°€ ë¬´ì‹í•˜ê²Œ ê¸¸ì–´ì§€ëŠ” ê±¸ ë°©ì§€ */
    #right-keypad { 
        height: 100% !important; 
        max-height: 350px !important; /* ì´ ìˆ«ìë¥¼ ì¤„ì´ë©´ í‚¤ë³´ë“œì˜ ìœ„ì•„ë˜ ë†’ì´ê°€ ì‘ì•„ì§‘ë‹ˆë‹¤ */
        margin: auto 0; /* í‚¤ë³´ë“œë¥¼ í™”ë©´ ì„¸ë¡œ ì¤‘ì•™ì— ë°°ì¹˜ */
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    .abacus-frame { transform: scale(0.75) !important; }
    .result-card { max-height: 90vh !important; width: 460px !important; padding: 15px !important; }
    .history-list { max-height: 120px !important; }
    #display-answer { height: 50px !important; font-size: 2rem !important; }
}
    </style>
</head>
<body oncontextmenu="return false" onclick="handleAutoFullscreen()">

    <div id="fs-trigger" style="position:fixed; inset:0; background:#000; z-index:20000; display:flex; flex-direction:column; align-items:center; justify-content:center; cursor:pointer;">
        <h1 style="color:var(--purple); font-family:'Orbitron'; letter-spacing: 5px;">ENTER CHAMPIONSHIP</h1>
        <input type="text" id="user-name" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" onclick="event.stopPropagation()" style="margin-top:20px; padding:12px; font-size:1.4rem; text-align:center; border-radius:10px; border:none; width:220px;">
        <button onclick="goFullScreen()" style="margin-top:20px; padding:15px 40px; background:var(--purple); color:white; border:none; border-radius:10px; font-size:1.2rem; font-weight:900; cursor:pointer;">ì‹œì‘í•˜ê¸°</button>
    </div>
    
    <div id="time-over-screen" style="position:fixed; inset:0; background:#000; z-index:21000; display:none; align-items:center; justify-content:center; font-size:5rem; font-weight:900; color:var(--red); font-family:'Orbitron';">TIME OVER</div>

    <div id="left-panel">
        <div id="timer-display">08:00</div>
        <div id="course-title">ë§ì…ˆì´ˆê¸‰</div>
        <div id="reversal-notice">âš¡ ì—­ì „ ì„±ê³µ! âš¡</div>
        <div id="step-info">STEP 1/90</div>
        <button class="log-btn" onclick="showPracticeLogs()">ğŸ“œ ì—°ìŠµê¸°ë¡</button>
        <div id="hall-of-fame"></div>
    </div>

    <div id="center-game">
        <div id="feedback-area"><div id="feedback-icon"></div></div>
        <div id="display-main"></div>
        <div id="rolling-stage" style="position:absolute; inset:0; pointer-events:none; display:flex; justify-content:center; align-items:center;"></div>
        <div id="hint-text" style="font-size:1.2rem; color:rgba(255,255,255,0.15); font-weight:400; text-align:center; display:none; position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); width:100%; z-index:11;">ë‹µì„ ì…ë ¥í•˜ì„¸ìš”!!</div>
    </div>

    <div id="right-keypad">
        <div id="display-answer"></div>
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; flex: 1;">
            <div class="key" onpointerdown="fnIn('1')">1</div><div class="key" onpointerdown="fnIn('2')">2</div><div class="key" onpointerdown="fnIn('3')">3</div>
            <div class="key" style="grid-column: 4; grid-row: 1 / 5; background: var(--green); color: #000; writing-mode: vertical-rl; text-orientation: upright; font-size: 1.4rem; letter-spacing: 4px;" onpointerdown="fnOk()">í™•ì¸</div>
            <div class="key" onpointerdown="fnIn('4')">4</div><div class="key" onpointerdown="fnIn('5')">5</div><div class="key" onpointerdown="fnIn('6')">6</div>
            <div class="key" onpointerdown="fnIn('7')">7</div><div class="key" onpointerdown="fnIn('8')">8</div><div class="key" onpointerdown="fnIn('9')">9</div>
            <div class="key" style="background:#333;" onpointerdown="fnIn('AC')">AC</div><div class="key" onpointerdown="fnIn('0')">0</div><div class="key" onpointerdown="fnIn('back')">â†</div>
        </div>
    </div>

    <div id="history-popup">
        <div style="background: rgba(10, 10, 10, 0.95); padding: 25px 20px; border-radius: 20px; border: 2px solid var(--gold); width: 340px; max-height: 80vh; position: relative; box-shadow: 0 0 30px rgba(0,0,0,0.8);">
            <div class="close-x" onclick="document.getElementById('history-popup').style.display='none'">&times;</div>
            <h3 style="color:var(--gold); text-align:center; margin-top:0; font-size:1.3rem; letter-spacing: -1px; margin-bottom: 20px;">ğŸ† ë‚´ ì—°ìŠµ ê¸°ë¡ <span style="font-size:0.8rem; color:#666; font-weight:normal;">(ìµœê·¼ìˆœ)</span></h3>
            <div id="my-log-list" style="max-height: 50vh; overflow-y: auto; padding-right: 5px;"></div>
            <button onclick="document.getElementById('history-popup').style.display='none'" style="width:100%; margin-top:20px; padding:12px; background: #222; color: #aaa; border: 1px solid #444; border-radius: 10px; font-weight: bold; cursor: pointer;">ë‹«ê¸°</button>
        </div>
    </div>

    <div id="schulte-overlay">
        <div class="game-header" id="mini-game-header">
            <div id="game-target-msg">ë¯¸ì…˜ ì¤€ë¹„ì¤‘...</div>
            <div id="schulte-timer-container"><div id="schulte-timer-bar"></div></div>
        </div>
        <div id="schulte-table" class="schulte-grid"></div>
        <div id="block-container"></div>
        <div id="schulte-msg"></div>
    </div>

    <script>
        // ì´ˆê¸‰ìš© ë¬¸ì œ ë°ì´í„°
        const problems = { 
1:{type:'board',row:3,dig:1},
2:{type:'board',row:3,dig:1},
3:{type:'board',row:3,dig:1},
4:{type:'board',row:4,dig:1},
5:{type:'board',row:4,dig:1},

6:{type:'flash',row:3,speed:700,dig:1},
7:{type:'flash',row:3,speed:700,dig:1},
8:{type:'flash',row:3,speed:700,dig:1},
9:{type:'flash',row:4,speed:700,dig:1},
10:{type:'flash',row:4,speed:700,dig:1},

11:{type:'rolling',row:3,speed:1000,dig:1},
12:{type:'rolling',row:3,speed:1000,dig:1},
13:{type:'rolling',row:4,speed:1200,dig:1},
14:{type:'rolling',row:4,speed:1200,dig:1},
15:{type:'rolling',row:4,speed:1200,dig:1},

16:{type:'abacus',dig:2,speed:1500},
17:{type:'abacus',dig:2,speed:1500},
18:{type:'abacus',dig:2,speed:1500},
19:{type:'abacus',dig:3,speed:1500},
20:{type:'abacus',dig:3,speed:1500},
21:{type:'abacus',dig:3,speed:1500},
22:{type:'abacus',dig:4,speed:1500},
23:{type:'abacus',dig:4,speed:1500},
24:{type:'abacus',dig:5,speed:1500},
25:{type:'abacus',dig:5,speed:1500},

26:{type:'board',row:5,dig:1},
27:{type:'board',row:5,dig:1},
28:{type:'board',row:7,dig:1},
29:{type:'board',row:7,dig:1},
30:{type:'board',row:2,dig:2},
31:{type:'board',row:3,dig:2},

32:{type:'flash',row:5,speed:700,dig:1},
33:{type:'flash',row:5,speed:700,dig:1},
34:{type:'flash',row:7,speed:700,dig:1},
35:{type:'flash',row:2,speed:700,dig:2},
36:{type:'flash',row:2,speed:700,dig:2},
37:{type:'flash',row:3,speed:700,dig:2},
38:{type:'flash',row:3,speed:700,dig:2},

39:{type:'rolling',row:5,speed:1200,dig:1},
40:{type:'rolling',row:5,speed:1200,dig:1},
41:{type:'rolling',row:7,speed:1200,dig:1},
42:{type:'rolling',row:7,speed:1200,dig:1},
43:{type:'rolling',row:2,speed:1200,dig:2},
44:{type:'rolling',row:2,speed:1300,dig:2},
45:{type:'rolling',row:3,speed:1300,dig:2},

46:{type:'numread',dig:2,speed:1500},
47:{type:'numread',dig:2,speed:1500},
48:{type:'numread',dig:3,speed:1500},
49:{type:'numread',dig:3,speed:1500},
50:{type:'numread',dig:4,speed:2000},
51:{type:'numread',dig:4,speed:2000},
52:{type:'numread',dig:4,speed:2000},
53:{type:'numread',dig:5,speed:2000},
54:{type:'numread',dig:5,speed:2000},
55:{type:'numread',dig:5,speed:2000},

56:{type:'board',row:3,dig:2},
57:{type:'board',row:3,dig:2},
58:{type:'board',row:3,dig:2},
59:{type:'board',row:4,dig:2},
60:{type:'board',row:4,dig:2},
61:{type:'board',row:5,dig:2},

62:{type:'flash',row:5,speed:600,dig:1},
63:{type:'flash',row:7,speed:600,dig:1},
64:{type:'flash',row:7,speed:600,dig:1},
65:{type:'flash',row:2,speed:700,dig:2},
66:{type:'flash',row:2,speed:700,dig:2},
67:{type:'flash',row:3,speed:700,dig:2},
68:{type:'flash',row:3,speed:700,dig:2},

69:{type:'rolling',row:7,speed:1200,dig:1},
70:{type:'rolling',row:7,speed:1200,dig:1},
71:{type:'rolling',row:9,speed:1200,dig:1},
72:{type:'rolling',row:9,speed:1200,dig:1},
73:{type:'rolling',row:3,speed:1200,dig:2},
74:{type:'rolling',row:3,speed:1300,dig:2},
75:{type:'rolling',row:4,speed:1300,dig:2},

76:{type:'board',row:5,dig:2},
77:{type:'board',row:5,dig:2},
78:{type:'board',row:5,dig:2},

79:{type:'flash',row:5,speed:500,dig:1},
80:{type:'flash',row:7,speed:500,dig:1},
81:{type:'flash',row:3,speed:500,dig:2},
82:{type:'flash',row:3,speed:500,dig:2},
83:{type:'flash',row:4,speed:600,dig:2},
84:{type:'flash',row:5,speed:700,dig:2},

85:{type:'rolling',row:10,speed:1300,dig:1},
86:{type:'rolling',row:10,speed:1300,dig:1},

87:{type:'board',row:5,dig:2},
88:{type:'board',row:5,dig:2},

89:{type:'rolling',row:5,speed:1300,dig:2},
90:{type:'rolling',row:5,speed:1300,dig:2} };
        const titles = {board:'ê²Œì‹œì•”ì‚°',flash:'í”Œë˜ì‰¬ì•”ì‚°',rolling:'ë¡¤ë§ì•”ì‚°',abacus:'ì£¼íŒì½ê¸°',numread:'ìˆ«ìì½ê¸°'};
        let cur=1, userAns="", ans=0, busy=false, audioCtx, lastType="", isGaming=false, schulteIdx=1, totalScore=0, timeLeft=480, mainTimer, playerName="", isTimeUp=false, blockGameCount=0, lastTopPlayer="";

        function initAudio() { if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
        function playSfx(type) { if(!audioCtx) return; if(audioCtx.state==='suspended') audioCtx.resume(); const now = audioCtx.currentTime; if(type==='magic' || type==='bonus'){ [880, 1318].forEach((f, i) => { const osc = audioCtx.createOscillator(), gain = audioCtx.createGain(); osc.type = 'sine'; osc.connect(gain); gain.connect(audioCtx.destination); osc.frequency.setValueAtTime(f, now + i*0.05); gain.gain.setValueAtTime(0, now + i*0.05); gain.gain.linearRampToValueAtTime(0.06, now + i*0.05 + 0.02); gain.gain.exponentialRampToValueAtTime(0.001, now + i*0.05 + 0.3); osc.start(now + i*0.05); osc.stop(now + i*0.05 + 0.4); }); } else if(type==='click'){ const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.frequency.setValueAtTime(1000,now); g.gain.setValueAtTime(0.05,now); o.start(); o.stop(now+0.05); } else if(type==='correct'){ const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.frequency.setValueAtTime(600,now); g.gain.setValueAtTime(0.1,now); o.start(); o.stop(now+0.2); } else if(type==='wrong'){ const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.frequency.setValueAtTime(220,now); g.gain.setValueAtTime(0.05,now); o.start(); o.stop(now+0.15); if(window.navigator.vibrate) window.navigator.vibrate(200); } else if(type==='typechange'){ [880, 1109, 1318].forEach((f, i) => { const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.frequency.setValueAtTime(f, now+i*0.1); g.gain.setValueAtTime(0.02, now+i*0.1); o.start(now+i*0.1); o.stop(now+i*0.1+0.3); }); } else if(type==='finish'){ [440, 554, 659, 880].forEach((f, i) => { const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.type='sine'; o.frequency.setValueAtTime(f, now+i*0.15); g.gain.setValueAtTime(0.1, now+i*0.15); o.start(now+i*0.15); o.stop(now+i*0.15+0.8); }); } }




// í˜ì´ì§€ê°€ ì—´ë¦¬ìë§ˆì ì‹¤í–‰ë˜ëŠ” ë¶€ë¶„
window.onload = function() {
    // 1. ë¡œê·¸ì¸ ì‹œ ì €ì¥í–ˆë˜ ì´ë¦„ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
    const savedName = localStorage.getItem('userName');
    
    if (savedName) {
        // ì´ë¦„ì´ ìˆìœ¼ë©´ ì…ë ¥ì°½ì— ë¯¸ë¦¬ ë„£ìŠµë‹ˆë‹¤.
        const nameInput = document.getElementById('user-name');
        if(nameInput) nameInput.value = savedName;
        
        // í™˜ì˜ ë©”ì‹œì§€ë¥¼ ë°”ê¿‰ë‹ˆë‹¤.
        const titleH1 = document.querySelector('#fs-trigger h1');
        if(titleH1) titleH1.innerText = savedName + "ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!";
    }
    
    // ì‹œì‘ ì „ì—ë„ ë­í‚¹íŒì„ í•œ ë²ˆ ë¯¸ë¦¬ ë³´ì—¬ì¤ë‹ˆë‹¤.
    updateHallOfFame();
};


function goFullScreen() { 
    const userNameInput = document.getElementById('user-name');
    // ë¡œê·¸ì¸ ì´ë¦„ì´ ìš°ì„ , ì—†ìœ¼ë©´ ì…ë ¥ì°½ ì´ë¦„, ê·¸ê²ƒë„ ì—†ìœ¼ë©´ "ê²ŒìŠ¤íŠ¸"
    const finalName = localStorage.getItem('userName') || userNameInput.value.trim() || "ê²ŒìŠ¤íŠ¸";
    
    playerName = finalName; 
    initAudio(); 
    if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();

    // ì „ì²´í™”ë©´ ëª¨ë“œ ì‹¤í–‰
    const docElm = document.documentElement;
    if (docElm.requestFullscreen) docElm.requestFullscreen();
    else if (docElm.webkitRequestFullScreen) docElm.webkitRequestFullScreen();

    document.getElementById('fs-trigger').style.display = 'none'; // ì‹œì‘ í™”ë©´ ìˆ¨ê¸°ê¸°
    
    if(!mainTimer) { 
        startTimer(); // íƒ€ì´ë¨¸ ì‹œì‘
        updateHallOfFame(); // ë­í‚¹ ë¶ˆëŸ¬ì˜¤ê¸°
        showSchulte(3, 15000); // ì²« ë¯¸ì…˜ ì‹œì‘
    } 
}

function handleAutoFullscreen() { 
    if(!document.fullscreenElement && mainTimer) {
        document.documentElement.requestFullscreen().catch(()=>{}); 
    }
}



        function startTimer() { mainTimer = setInterval(() => { if(isTimeUp) return; timeLeft--; let m = Math.floor(timeLeft/60), s = timeLeft%60; document.getElementById('timer-display').innerText = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; saveRecord(false); if(timeLeft <= 0) { isTimeUp = true; clearInterval(mainTimer); showTimeOver(); } }, 1000); }
        function getFormattedDate() { const now = new Date(); return `${String(now.getFullYear()).slice(-2)}.${String(now.getMonth()+1).padStart(2,'0')}.${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`; }

function saveRecord(finished) { 
    // [1] Firebase ì„¤ì • (ì„ ìƒë‹˜ì˜ ì„¤ì •ê°’ìœ¼ë¡œ ì±„ìš°ì„¸ìš”)
  const firebaseConfig = {
    apiKey: "AIzaSyCbhFq8vcLem8DoMdlsXpC-ZRYELhJSFHU",
    authDomain: "championship-8f923.firebaseapp.com",
    databaseURL: "https://championship-8f923-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "championship-8f923",
    storageBucket: "championship-8f923.firebasestorage.app",
    messagingSenderId: "118704807417",
    appId: "1:118704807417:web:b1cacb9636d51a38d67128",
    measurementId: "G-KLHCC95R2C"
  }

if (!firebase.apps.length) return; // íŒŒì´ì–´ë² ì´ìŠ¤ ë¯¸ì—°ê²°ì‹œ ì¤‘ë‹¨
    var db = firebase.database();
    var userLogId = localStorage.getItem('loginId') || "guest_" + playerName; 

    let record = { 
        name: playerName, 
        score: totalScore, 
        lastActive: Date.now(), 
        isPlaying: !finished, 
        fullDate: getFormattedDate(), 
        timeLeft: timeLeft 
    }; 

    // ì‹¤ì‹œê°„ ë­í‚¹íŒìš© ì €ì¥
    db.ref('rankings/rank_add_base/' + userLogId).set(record);

    // ì™„ì£¼ ì‹œ ë³´ìƒ ë° ê´€ë¦¬ì ê¸°ë¡ ì €ì¥
    if (finished || isTimeUp) {
        let earnedGems = Math.floor(totalScore / 10);
        let oldBest = parseInt(localStorage.getItem('myBestScore_base') || 0);
        let earnedCoins = (totalScore > oldBest) ? 100 : 0;
        
        if (earnedCoins > 0) localStorage.setItem('myBestScore_base', totalScore);

        let totalGems = (parseInt(localStorage.getItem('userGems') || 0)) + earnedGems;
        let totalCoins = (parseInt(localStorage.getItem('userCoins') || 0)) + earnedCoins;
        
        localStorage.setItem('userGems', totalGems);
        localStorage.setItem('userCoins', totalCoins);

        if (userLogId && userLogId !== 'admin') {
            db.ref('users/' + userLogId).update({
                name: playerName,
                gems: totalGems,
                coins: totalCoins,
                bestScore: Math.max(oldBest, totalScore),
                lastDate: new Date().toLocaleString()
            });
        }
    }
    updateHallOfFame(); 
}

// [3] ë­í‚¹íŒ ì—…ë°ì´íŠ¸ (ì„ ìƒë‹˜ ì½”ë“œ ë³´ì™„)
function updateHallOfFame() {
    if (!firebase.apps.length) return;
    firebase.database().ref('rankings/rank_add_base').once('value', function(snapshot) {
        const data = snapshot.val() || {};
        const ranks = Object.values(data).sort((a, b) => b.score - a.score || (b.timeLeft || 0) - (a.timeLeft || 0));

        let html = ""; 
        const medals = ["ğŸ¥‡", "ğŸ¥ˆ", "ğŸ¥‰", "ğŸ…", "ğŸ–ï¸"]; 
        let displayRank = 0;
        let lastScore = -1;
        let lastTime = -1;
        const currentTime = Date.now();

        ranks.forEach((r, i) => {
            if (r.score !== lastScore || (r.timeLeft || 0) !== lastTime) displayRank++;
            lastScore = r.score;
            lastTime = (r.timeLeft || 0);

            let isMeClass = (r.name === playerName) ? 'my-record' : ''; 
            let isActive = r.isPlaying && r.lastActive && (currentTime - r.lastActive < 180000);
            
            // updateHallOfFame í•¨ìˆ˜ ì•ˆì˜ html ë§Œë“œëŠ” ë¶€ë¶„ í™•ì¸
html += `
    <div class="rank-item color-${displayRank<=5?displayRank:'other'} ${isActive ? 'is-playing' : ''} ${isMeClass}">
        <div style="display:flex; align-items:center; gap:5px;">
            <span>${displayRank<=5 ? medals[displayRank-1] : ''} ${displayRank}. ${r.name}</span>
            ${isActive ? '<span style="font-size:1.1rem; filter:drop-shadow(0 0 2px gold);">âš¡</span>' : ''}
        </div>
        <span style="font-family:'Orbitron'; font-weight:900;">${r.score}</span>
    </div>`;
        });
        const container = document.getElementById('hall-of-fame');
        if(container) container.innerHTML = html;
    });
}


        function showPracticeLogs() { 
    const list = document.getElementById('my-log-list'); 
    const title = document.getElementById('course-title').innerText; 
    let ranks = JSON.parse(localStorage.getItem('rank_add_base') || "[]"); 
    let myLogs = ranks.filter(r => r.realName === playerName.replace(/[0-9]/g, '')).sort((a,b)=>b.lastActive - a.lastActive);
    
    // í—¤ë” ì¶”ê°€ ë° ë¦¬ìŠ¤íŠ¸ ì¶œë ¥
    list.innerHTML = `
        <div style="display:grid; grid-template-columns: 1.2fr 1fr 0.6fr; padding: 5px 8px; font-size: 0.6rem; color: #555; border-bottom: 1px solid #333;">
            <span>ì—°ìŠµì¼ì‹œ(${title})</span><span style="text-align:center;">ì†Œìš”ì‹œê°„</span><span style="text-align:right;">ì ìˆ˜</span>
        </div>
    `;

    list.innerHTML += myLogs.map(l => {
        const spent = 480 - (l.timeLeft || 0); 
        const m = Math.floor(spent/60);
        const s = spent%60;
        // 8ë¶„(480ì´ˆ) ê½‰ ì±„ì› ê±°ë‚˜ ì´ˆê³¼ ì‹œ íšŒìƒ‰ 8:00, ì´ë‚´ ì™„ë£Œ ì‹œ ë³´ë¼ìƒ‰ ì†Œìš”ì‹œê°„
        const isTimeOver = spent >= 480;
        const durationColor = isTimeOver ? "#888" : "var(--purple)";
        const durationText = isTimeOver ? "08:00" : `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;

        return `
        <div class="history-item" style="grid-template-columns: 1.2fr 1fr 0.6fr;">
            <span class="log-date">${l.fullDate}</span>
            <span class="log-duration" style="color:${durationColor}; text-align:center; font-weight:bold;">${durationText}</span>
            <span class="log-score">${l.score}</span>
        </div>`;
    }).join(''); 
    document.getElementById('history-popup').style.display = 'flex'; 
}

        function fnIn(k) { if(busy || isTimeUp) return; playSfx('click'); if(k==='AC') userAns=""; else if(k==='back') userAns=userAns.slice(0,-1); else if(userAns.length<8) userAns+=k; document.getElementById('display-answer').innerText=userAns; }
        function fnOk() { if(busy || userAns === "" || isTimeUp) return; busy = true; const icon = document.getElementById('feedback-icon'); icon.style.display = 'block'; if(parseInt(userAns) === ans){ playSfx('correct'); icon.innerText = "âœ“"; icon.className = "correct"; totalScore++; } else { playSfx('wrong'); icon.innerText = "âœ•"; icon.className = "wrong"; } setTimeout(() => { icon.style.display = 'none'; cur++; saveRecord(false); initGame(); }, 800); }

        function initGame() { 
            if(isTimeUp) return; if(isGaming) return; 
            if(cur===26&&schulteIdx===1){schulteIdx=2; showSchulte(4,25000); return;} 
            if(cur===56&&schulteIdx===2){schulteIdx=3; startBlockGame(); return;} 
            if(cur===76&&schulteIdx===3){schulteIdx=4; startBlockGame(); return;} 
            if(cur>90 && schulteIdx===4){ schulteIdx=5; showSchulte(5,35000); return; }
            if(cur>90 && schulteIdx===5){ showFinalResult(); return; } 
            const p=problems[cur]; userAns=""; document.getElementById('display-answer').innerText=""; 
            document.getElementById('step-info').innerText=`STEP ${cur}/90`; document.getElementById('hint-text').style.display='none'; 
            const main=document.getElementById('display-main'); main.innerHTML = ""; busy=false; 
            if(p.type!==lastType){ playSfx('typechange'); main.innerHTML=`<div style="font-size:2rem; color:var(--purple);">[ ${titles[p.type]} ]</div>`; lastType=p.type; setTimeout(()=>runProblem(p),1200); } 
            else runProblem(p); 
        }

        function runProblem(p) {
            const main = document.getElementById('display-main'), stage = document.getElementById('rolling-stage');
            main.innerHTML = ""; stage.innerHTML = ""; let nums = [], ansVal = 0;
            if (p.type === 'abacus' || p.type === 'numread') {
                let s = ""; for (let i = 0; i < p.dig; i++) s += (i === 0) ? Math.floor(Math.random() * 9) + 1 : Math.floor(Math.random() * 10);
                ans = parseInt(s);
                if (p.type === 'abacus') { 
                    main.innerHTML = (function(num){
                        let h=`<div class="abacus-frame"><div class="master-divider"></div>`;
                        num.toString().split('').forEach(d=>{ const v=parseInt(d); h+=`<div class="column"><div class="rod"></div>`; if(v>=5) h+=`<div class="bead upper-bead" style="top:55px;"></div>`; for(let j=1; j<=(v%5); j++) h+=`<div class="bead" style="top:${101 + (j-1)*34}px; position:absolute;"></div>`; h+=`</div>`; });
                        return h+`</div>`;
                    })(s);
                } else main.innerText = s;
                setTimeout(() => { if(!isTimeUp) { main.innerHTML = ""; document.getElementById('hint-text').style.display = 'block'; } }, 1500); 
            } else {
                for (let i = 0; i < p.row; i++) { let min = Math.pow(10, p.dig - 1), max = Math.pow(10, p.dig) - 1; let n = Math.floor(Math.random() * (max - min + 1)) + min; nums.push(n); ansVal += n; }
                ans = ansVal;


                if (p.type === 'board') {
               let bHtml = `<div class="board-list ${p.row === 5 ? 'board-rows-5' : p.row >= 7 ? 'board-rows-7' : 'board-rows-234'}" style="line-height:1.1; color:var(--green); text-align:center; letter-spacing:2px; display:flex; flex-direction:column; align-items:center; width:100%;">`;


                    nums.forEach(n => bHtml += `<div>${n}</div>`);
                    main.innerHTML = bHtml + `<div style="width:200px; border-bottom:4px solid rgba(255,255,255,0.4); margin:12px auto;"></div><div style="font-size:1.1rem; color:rgba(255,255,255,0.15);">ë‹µì„ ì…ë ¥í•˜ì„¸ìš”!!</div></div>`;
                } else if (p.type === 'flash') {
                    let idx = 0; let iv = setInterval(() => { if(isTimeUp){clearInterval(iv); return;} playSfx('click'); main.innerText = nums[idx++]; setTimeout(() => { main.innerText = ""; if (idx >= nums.length && !isTimeUp) document.getElementById('hint-text').style.display = 'block'; }, p.speed - 100); if (idx >= nums.length) clearInterval(iv); }, p.speed);
                } else if (p.type === 'rolling') { 
                    let idx = 0; let iv = setInterval(() => { if(isTimeUp){clearInterval(iv); return;} if (idx === 0) playSfx('click'); const d = document.createElement('div'); d.className = 'rolling-num'; d.innerText = nums[idx++]; d.style.setProperty('--roll-dur', (p.speed + 800) + 'ms'); stage.appendChild(d); if (idx >= nums.length) { clearInterval(iv); setTimeout(() => { if(!isTimeUp) document.getElementById('hint-text').style.display = 'block'; }, p.speed + 400); } }, 350); 
                }
            }
        }

// [ìŠí…Œí‘œ & ë¸”ë¡ê²Œì„ ë³µêµ¬ ì½”ë“œ - ë””ìì¸ ìœ ì§€]

function showSchulte(size, timeLimit) {
    if(isTimeUp) return; isGaming=true; busy=true; 
    
    const overlay=document.getElementById('schulte-overlay');
    const table=document.getElementById('schulte-table');
    const bar=document.getElementById('schulte-timer-bar');
    const msgArea=document.getElementById('schulte-msg');
    const header=document.getElementById('mini-game-header');

    overlay.style.display='flex'; table.innerHTML=''; table.style.display='grid'; 
    msgArea.style.display='none'; header.style.display='flex';

    // ë ˆì´ì•„ì›ƒ ì¡°ì •
    header.style.position = "relative";
    header.style.top = (size === 5) ? "-40px" : "-10px";
    if (size === 5) table.style.marginTop = "-40px";

    document.getElementById('block-container').style.display='none'; 
    document.getElementById('game-target-msg').innerText = `[ìŠí…Œí‘œ : 1ë¶€í„° ì°¨ë¡€ëŒ€ë¡œ ëˆ„ë¥´ê¸°]`;
    
    table.style.gridTemplateColumns=`repeat(${size}, 1fr)`;
    let next=1, max=size*size, nums=Array.from({length:max},(_,i)=>i+1).sort(()=>Math.random()-0.5);
    
    nums.forEach(n=>{ 
        const cell=document.createElement('div'); 
        cell.className='schulte-cell'; 
        cell.innerText=n; 
        cell.onpointerdown=(e)=>{ 
            e.preventDefault(); 
            if(n===next){ 
                playSfx('click'); 
                cell.style.visibility='hidden'; 
                next++; 
                if(next>max) finishSchulte(true); 
            } 
        }; 
        table.appendChild(cell); 
    });

    let start=Date.now(); 
    let si=setInterval(()=>{ 
        let rem=Math.max(0,timeLimit-(Date.now()-start)); 
        bar.style.width=(rem/timeLimit*100)+"%"; 
        if(rem<=0||!isGaming||isTimeUp){ 
            clearInterval(si); 
            if(rem<=0&&isGaming&&!isTimeUp) finishSchulte(false); 
        } 
    },50);
}

function finishSchulte(success) { 
    isGaming = false; 
    const msg=document.getElementById('schulte-msg'), 
          table=document.getElementById('schulte-table'), 
          header=document.getElementById('mini-game-header'); 
    table.style.display='none'; header.style.display='none'; msg.style.display='flex'; 
    
    if(success) { 
        totalScore+=2; 
        playSfx('bonus'); 
        msg.innerHTML=`<div style="color:var(--green); font-size:2.5rem; font-weight:900;">ì„±ê³µ ! ë³´ë„ˆìŠ¤ +2ì </div>`; 
    } else { 
        msg.innerHTML=`<div style="color:var(--red); font-size:2rem; font-weight:900;">ì‹œê°„ ì´ˆê³¼</div>`; 
    }
    setTimeout(()=>{ 
        document.getElementById('schulte-overlay').style.display='none'; 
        msg.style.display='none'; 
        busy=false; 
        initGame(); 
    },1500); 
}

// ë¸”ë¡ê²Œì„(10ë§Œë“¤ê¸°/20ë§Œë“¤ê¸°) ë³µêµ¬
function startBlockGame() {
    if(isTimeUp) return; isGaming=true; busy=true; blockGameCount++;
    const header=document.getElementById('mini-game-header'), 
          area=document.getElementById('block-container'), 
          bar=document.getElementById('schulte-timer-bar'), 
          msgArea=document.getElementById('schulte-msg');
    header.style.display='flex'; header.style.position = "absolute"; header.style.top = "40px";
    document.getElementById('schulte-overlay').style.display='flex'; 
    area.style.display='block'; area.innerHTML=""; 
    document.getElementById('schulte-table').style.display='none';
    
    let targetSum = (blockGameCount===1)?10:20; 
    document.getElementById('game-target-msg').innerText = `[${targetSum} ë§Œë“¤ê¸°]`;
    
    let bScore=0, bTime=30.0, sel=null, stackedBlocks=[]; 
    const B_SIZE=60, cols = Math.floor(window.innerWidth / 70);

    function spawnGroup() { 
        if(!isGaming||isTimeUp) return; 
        let count = 4 + Math.floor(Math.random()*2);
        for(let i=0; i<count; i++) {
            let val = Math.floor(Math.random()*(targetSum-1))+1, col = Math.floor(Math.random()*cols); 
            const b=document.createElement('div'); b.className='block'; b.innerText=val; b.style.left=(col*70 + 10)+"px"; b.style.top="-80px"; 
            b.style.background=`linear-gradient(135deg, hsl(${Math.random()*360},70%,50%), hsl(${Math.random()*360},70%,30%))`; 
            b.onpointerdown=(e)=>{
                e.preventDefault();
                if(sel===b){ sel=null; b.style.border="none"; }
                else if(!sel){ sel=b; b.style.border="4px solid #fff"; }
                else {
                    if(parseInt(sel.innerText)+parseInt(b.innerText)===targetSum){
                        playSfx('magic');
                        stackedBlocks=stackedBlocks.filter(x=>x!==sel && x!==b);
                        sel.remove(); b.remove(); bScore++; sel=null;
                    } else {
                        playSfx('click'); sel.style.border="none"; sel=b; b.style.border="4px solid #fff";
                    }
                }
            }; 
            area.appendChild(b); stackedBlocks.push(b);
            setTimeout(() => { b.style.top = (area.clientHeight - B_SIZE - 5) + "px"; }, 50);
        }
        if(isGaming) setTimeout(spawnGroup, 1200); 
    }
    
    function finishBlock(){ 
        isGaming=false; area.style.display='none'; header.style.display='none'; 
        let bonus = (bScore>=10)?2:(bScore>=5)?1:0; totalScore+=bonus; 
        if(bonus>0) playSfx('bonus');
        msgArea.style.display='flex'; 
        msgArea.innerHTML=`<div style="font-size:2rem; font-weight:900; color:var(--gold); text-align:center;">ë§ì¶˜ ê°œìˆ˜: ${bScore}ê°œ<br><span style="color:var(--green);">ë³´ë„ˆìŠ¤ +${bonus}ì </span></div>`; 
        setTimeout(()=>{document.getElementById('schulte-overlay').style.display='none'; msgArea.style.display='none'; busy=false; initGame();},2500); 
    } 
    spawnGroup(); 
    let ti=setInterval(()=>{ 
        if(isTimeUp||!isGaming){clearInterval(ti); return;} 
        bTime-=0.1; bar.style.width=(bTime/30*100)+"%"; 
        if(bTime<=0){clearInterval(ti); finishBlock();} 
    },100);
}

        function showTimeOver() { isTimeUp = true; const tos = document.getElementById('time-over-screen'); tos.style.display = 'flex'; playSfx('finish'); setTimeout(() => { tos.style.display = 'none'; showFinalResult(); }, 2000); }

function showFinalResult() { 
    saveRecord(true); 
    const msgArea = document.getElementById('schulte-msg');
    const spent = 480 - timeLeft;
    const timeDisplay = (spent >= 480) ? "08:00 (Time Over)" : `${Math.floor(spent/60)}:${String(spent%60).padStart(2,'0')}`;

    // [í•µì‹¬ ìˆ˜ì •] ì„œë²„ì—ì„œ ì „ì²´ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ì„œ ê²°ê³¼ì°½ì„ ë§Œë“­ë‹ˆë‹¤.
    firebase.database().ref('rankings/rank_add_base').once('value', function(snapshot) {
        const data = snapshot.val() || {};
        const allRanks = Object.values(data).sort((a,b) => b.score - a.score || (b.timeLeft - a.timeLeft));
        
        // ë‚´ ìˆœìœ„ ê³„ì‚°
        let myRank = allRanks.findIndex(r => r.name === playerName) + 1;
        const realNameOnly = playerName.replace(/[0-9]/g, ''); 

        // [ëª…ì˜ˆì˜ ì „ë‹¹] ì‹¤ì‹œê°„ ì „ì²´ ë­í‚¹ ë°ì´í„° ì •ë¦¬
        let html = "";
        allRanks.forEach((r, i) => {
            const displayRank = i + 1;
            const medals = ["ğŸ† 1ìœ„", "ğŸ¥ˆ 2ìœ„", "ğŸ¥‰ 3ìœ„", "ğŸ… 4ìœ„", "ğŸ–ï¸ 5ìœ„"];
            const rankLabel = i < 5 ? medals[i] : (i + 1) + '.';
            
            html += `
                <div class="history-item">
                    <span style="color:var(--gold); font-weight:900;">${rankLabel}</span>
                    <span style="color:#fff; font-weight:700;">${r.name}</span>
                    <span style="color:#888; font-size:0.55rem; text-align:center;">${r.fullDate || ''}</span>
                    <span style="text-align:right; font-weight:900; color:var(--green);">${r.score}</span>
                </div>`;
        });

        // ê²°ê³¼ì°½ í™”ë©´ êµ¬ì„±
        msgArea.innerHTML = `
            <div class="result-card">
                <h2 style="color:var(--green); margin:0 0 5px 0; font-size:1.1rem;">${realNameOnly}ë‹˜ ê²°ê³¼</h2>
                <div style="font-size:1.2rem; color:var(--gold); font-weight:900;">í˜„ì¬ ìˆœìœ„: ${myRank}ìœ„</div>
                <h1 style="font-size:3rem; margin:5px 0; color:white; text-shadow:0 0 10px var(--purple);">${totalScore}ì </h1>
                
                <div style="background:rgba(74, 222, 128, 0.1); padding:8px; border-radius:10px; margin-bottom:10px; border:1px solid var(--green);">
                    <span style="font-size:0.75rem; color:var(--green);">ì´ë²ˆ ê²Œì„ ë³´ìƒ:</span>
                    <span style="font-weight:900; margin-left:10px;">ğŸ’ ${Math.floor(totalScore/10)}  ğŸª™ ${totalScore > parseInt(localStorage.getItem('myBestScore_base')||0) ? 100 : 0}</span>
                </div>

                <div style="background:rgba(255,255,255,0.08); padding:10px; border-radius:12px; margin-bottom:12px; display:flex; justify-content:space-around; align-items:center;">
                    <div><div style="color:var(--gold); font-size:0.7rem;">ëˆ„ì  ë³´ì„</div><div style="font-size:1.2rem; font-weight:900;">ğŸ’ ${localStorage.getItem('userGems')||0}</div></div>
                    <div style="width:1px; height:25px; background:#444;"></div>
                    <div><div style="color:var(--purple); font-size:0.7rem;">ëˆ„ì  ì½”ì¸</div><div style="font-size:1.2rem; font-weight:900;">ğŸª™ ${localStorage.getItem('userCoins')||0}</div></div>
                </div>

                <div style="font-weight:900; color:var(--gold); font-size:0.8rem; margin-bottom:8px; border-bottom:1px solid #333; padding-bottom:5px;">ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹ (ì‹¤ì‹œê°„) ğŸ†</div>
                <div class="history-list" style="max-height:150px; overflow-y:auto;">${html}</div>
                
                <div style="display:flex; gap:10px; margin-top:15px;">
                    <button onclick="location.reload()" style="flex:1; padding:12px; background:var(--green); border:none; font-weight:900; border-radius:10px; cursor:pointer;">ë‹¤ì‹œ ì‹œì‘</button>
                    <button onclick="location.reload()" style="flex:1; padding:12px; background:var(--purple); color:white; border:none; font-weight:900; border-radius:10px; cursor:pointer; font-size:1.1rem; box-shadow:0 4px #7c3aed;">ë‹¤ì‹œ ë„ì „í•˜ê¸°!</button>
                </div>
            </div>`; 

        // í™”ë©´ ì „í™˜
        document.getElementById('schulte-overlay').style.display='flex'; 
        document.getElementById('mini-game-header').style.display='none'; 
        document.getElementById('schulte-table').style.display='none'; 
        document.getElementById('block-container').style.display='none'; 
        msgArea.style.display='flex';
    });
}
// í‚¤ë³´ë“œ ì…ë ¥ì„ ê°ì‹œí•´ì„œ ìˆ«ìí‚¤, ì—”í„°, ë°±ìŠ¤í˜ì´ìŠ¤ë¥¼ ì‘ë™í•˜ê²Œ í•©ë‹ˆë‹¤.
window.addEventListener('keydown', (e) => { 
    // ê²Œì„ ì¤‘ì´ ì•„ë‹ˆê±°ë‚˜ ì‹œê°„ì´ ë‹¤ ëìœ¼ë©´ ì‘ë™ ì•ˆ í•¨
    if(busy || isTimeUp) return; 
    
    if(e.key >= '0' && e.key <= '9') {
        fnIn(e.key); // ìˆ«ì ì…ë ¥
    } else if(e.key === 'Enter') {
        fnOk(); // í™•ì¸ ë²„íŠ¼
    } else if(e.key === 'Backspace') {
        fnIn('back'); // ì§€ìš°ê¸°
    } else if(e.key === 'Escape') {
        fnIn('AC'); // ì „ì²´ ì§€ìš°ê¸°
    } 
});

// 3ì´ˆë§ˆë‹¤ ë­í‚¹íŒì„ ìë™ìœ¼ë¡œ ìƒˆë¡œê³ ì¹¨í•´ì„œ ì¹œêµ¬ë“¤ ì ìˆ˜ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
setInterval(updateHallOfFame, 3000);


</script>
</body>
</html>
