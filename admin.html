<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CHAMPIONSHIP - í†µí•© ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Noto+Sans+KR:wght@300;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #0f172a; --panel: #1e293b; --purple: #c084fc;
            --gold: #facc15; --green: #4ade80; --red: #f87171; --blue: #3b82f6;
        }
        body { margin: 0; background: var(--bg); color: #fff; font-family: 'Noto Sans KR', sans-serif; padding: 10px; box-sizing: border-box; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--purple); padding-bottom: 10px; }
        h1 { font-family: 'Orbitron', sans-serif; margin: 0; color: var(--purple); font-size: 1.1rem; }
        
        section { background: var(--panel); padding: 15px; border-radius: 15px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.1); }
        h2 { font-size: 0.95rem; color: var(--purple); margin: 0 0 12px 0; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid var(--purple); padding-left: 8px; }
        
        .btn { border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; font-size: 0.8rem; transition: 0.2s; }
        .btn-approve { background: var(--green); color: #000; }
        .btn-delete { background: var(--red); }
        .btn-blue { background: var(--blue); }
        .btn-reset { background: #334155; font-size: 0.7rem; padding: 8px 4px; }
        
        input, select { background: #020617; border: 1px solid #334155; color: white; padding: 10px; border-radius: 8px; font-size: 0.85rem; outline: none; }
        
        .table-wrapper { width: 100%; overflow-x: auto; }
        .admin-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; min-width: 400px; }
        .admin-table th { border-bottom: 2px solid var(--purple); padding: 10px 5px; text-align: left; color: #94a3b8; }
        .admin-table td { padding: 10px 5px; border-bottom: 1px solid rgba(255,255,255,0.05); }

        /* ê¸°ë¡ ë³´ê¸° ëª¨ë‹¬ */
        #record-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 1000; justify-content: center; align-items: center; padding: 15px;
        }
        .modal-content { background: var(--panel); width: 100%; max-width: 500px; border-radius: 20px; padding: 15px; border: 2px solid var(--purple); max-height: 90vh; overflow-y: auto; }
        
        .report-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .report-column { display: flex; flex-direction: column; gap: 5px; }
        .subject-card { background: rgba(255,255,255,0.05); padding: 8px 10px; border-radius: 6px; border-left: 3px solid var(--blue); display: flex; justify-content: space-between; align-items: center; }
        .score-val { color: var(--gold); font-weight: bold; font-size: 0.8rem; }

        .log-list { background: #020617; border-radius: 10px; padding: 10px; max-height: 150px; overflow-y: auto; font-size: 0.7rem; }
        .reset-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
    </style>
</head>
<body>

<header>
    <h1>MASTER CONTROL</h1>
    <button class="btn btn-blue" style="padding:5px 10px;" onclick="location.href='ë¡œë¹„.html'">ë¡œë¹„</button>
</header>

<div id="admin-only-top" style="display: none;">
    <section style="border: 1px solid var(--red);">
        <h2 style="color:var(--red)">ğŸ“© ê°€ì… ìŠ¹ì¸ ëŒ€ê¸°</h2>
        <div id="request-list" style="font-size: 0.8rem;"></div>
    </section>

    <section>
        <h2>ğŸ† ì±”í”¼ì–¸ì‹­ ì»¨íŠ¸ë¡¤</h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
            <button class="btn btn-approve" onclick="alert('ëŒ€íšŒ ì‹œì‘!')">ëŒ€íšŒ ì‹œì‘</button>
            <button class="btn btn-delete" onclick="alert('ëŒ€íšŒ ì¢…ë£Œ')">ëŒ€íšŒ ì¢…ë£Œ</button>
            <button class="btn btn-blue" style="grid-column: span 2;" onclick="alert('ì „ê´‘íŒ ì‹¤í–‰')">ğŸ–¥ï¸ ì‹¤ì‹œê°„ ì „ê´‘íŒ ëª¨ë“œ</button>
        </div>
    </section>
</div>

<section>
    <h2>â• ì‚¬ìš©ì ì§ì ‘ ë“±ë¡</h2>
    <div style="display: flex; flex-direction: column; gap: 8px;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
            <select id="reg-type"><option value="í•™ìƒ">í•™ìƒ ë“±ë¡</option><option value="ì„ ìƒë‹˜">ì„ ìƒë‹˜ ë“±ë¡</option></select>
            <select id="reg-teacher-select"><option value="ê´€ë¦¬ì">ê´€ë¦¬ì ì§ì†</option></select>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
            <input type="text" id="reg-name" placeholder="ì„±í•¨/ì´ë¦„">
            <input type="text" id="reg-id" placeholder="ì•„ì´ë””">
        </div>
        <input type="password" id="reg-pw" placeholder="ë¹„ë°€ë²ˆí˜¸">
        <button class="btn btn-approve" onclick="directRegister()">ë“±ë¡í•˜ê¸°</button>
    </div>
</section>

<section>
    <h2>ğŸ‘¤ ì‚¬ìš©ì ê´€ë¦¬ <span id="user-count" style="font-size:0.8rem; margin-left:10px; color:var(--purple);">0ëª…</span></h2>
    <div style="display: flex; gap: 5px; margin-bottom: 10px;">
        <select id="filter-teacher" onchange="displayUserList()" style="flex: 1;"><option value="all">ì „ì²´ë³´ê¸°</option></select>
        <input type="text" id="search-input" onkeyup="displayUserList()" placeholder="ì´ë¦„ ê²€ìƒ‰" style="flex: 1;">
    </div>
    <div class="table-wrapper">
        <table class="admin-table">
            <thead>
                <tr>
                    <th>ì„±ëª…(ID)</th>
                    <th>ê¸°ë¡</th>
                    <th>ë ˆë²¨</th>
                    <th>ë‹´ë‹¹</th>
                    <th>ê´€ë¦¬</th>
                </tr>
            </thead>
            <tbody id="user-list-body"></tbody>
        </table>
    </div>
</section>

<section id="reset-section" style="display: none;">
    <h2 style="color:var(--red)">ğŸš¨ ìˆœìœ„íŒ ì´ˆê¸°í™”</h2>
    <div class="reset-grid">
        <div class="report-column">
            <button class="btn btn-reset" onclick="resetRank('ì•”ì‚°ì±”í”¼ì–¸')">ì•”ì‚°ì±”í”¼ì–¸ ë¦¬ì…‹</button>
            <button class="btn btn-reset" onclick="resetRank('ë§ì…ˆì´ˆê¸‰')">ë§ì…ˆì´ˆê¸‰ ë¦¬ì…‹</button>
            <button class="btn btn-reset" onclick="resetRank('ë§ì…ˆì¤‘ê¸‰')">ë§ì…ˆì¤‘ê¸‰ ë¦¬ì…‹</button>
            <button class="btn btn-reset" onclick="resetRank('ë§ì…ˆë§ˆìŠ¤í„°')">ë§ì…ˆë§ˆìŠ¤í„° ë¦¬ì…‹</button>
            <button class="btn btn-reset" onclick="resetRank('10ë§Œë“¤ê¸°')">10ë§Œë“¤ê¸° ë¦¬ì…‹</button>
            <button class="btn btn-reset" onclick="resetRank('24ë§Œë“¤ê¸°')">24ë§Œë“¤ê¸° ë¦¬ì…‹</button>
            <button class="btn btn-reset" onclick="resetRank('ìŠíƒœí‘œ')">ìŠíƒœí‘œ ë¦¬ì…‹</button>
        </div>
        <div class="report-column">
            <button class="btn btn-reset" onclick="resetRank('ê³±ì…ˆì´ˆê¸‰')">ê³±ì…ˆì´ˆê¸‰ ë¦¬ì…‹</button>
            <button class="btn btn-reset" onclick="resetRank('ê³±ì…ˆì¤‘ê¸‰')">ê³±ì…ˆì¤‘ê¸‰ ë¦¬ì…‹</button>
            <button class="btn btn-reset" onclick="resetRank('ê³±ì…ˆë§ˆìŠ¤í„°')">ê³±ì…ˆë§ˆìŠ¤í„° ë¦¬ì…‹</button>
            <button class="btn btn-reset" onclick="resetRank('ë‚˜ëˆ—ì…ˆì´ˆê¸‰')">ë‚˜ëˆ—ì…ˆì´ˆê¸‰ ë¦¬ì…‹</button>
            <button class="btn btn-reset" onclick="resetRank('ë‚˜ëˆ—ì…ˆì¤‘ê¸‰')">ë‚˜ëˆ—ì…ˆì¤‘ê¸‰ ë¦¬ì…‹</button>
            <button class="btn btn-reset" onclick="resetRank('ë‚˜ëˆ—ì…ˆë§ˆìŠ¤í„°')">ë‚˜ëˆ—ì…ˆë§ˆìŠ¤í„° ë¦¬ì…‹</button>
            <button class="btn btn-reset" style="background:var(--gold); color:#000;" onclick="resetRank('ì „ì²´ëŒ€íšŒ')">ëŒ€íšŒì „ì²´ ë¦¬ì…‹</button>
        </div>
    </div>
</section>

<div id="record-modal">
    <div class="modal-content">
        <h2 id="modal-user-name" style="font-size:1rem; margin-top:0; color:var(--purple);">í•™ìŠµ ë¦¬í¬íŠ¸</h2>
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 15px 0; font-size:0.85rem;">
            <div style="background:rgba(0,0,0,0.2); padding:10px; border-radius:10px; border:1px solid #334155;">
                <span style="color:var(--blue)">ğŸ’ ë³´ì„:</span> <span id="m-gem">0</span>
            </div>
            <div style="background:rgba(0,0,0,0.2); padding:10px; border-radius:10px; border:1px solid #334155;">
                <span style="color:var(--gold)">ğŸª™ ì½”ì¸:</span> <span id="m-coin">0</span>
            </div>
            <div style="background:rgba(0,0,0,0.2); padding:10px; border-radius:10px; border:1px solid #334155; grid-column: span 2;">
                <span style="color:var(--green)">ğŸ–ï¸ íšë“ ë±ƒì§€:</span> <span id="m-badges" style="color:#fff; margin-left:5px;">ì—†ìŒ</span>
            </div>
        </div>

        <h4 style="margin: 15px 0 10px 0; font-size:0.9rem; color:var(--gold);">ğŸ† ê³¼ëª©ë³„ ìµœê³  ê¸°ë¡</h4>
        <div class="report-grid">
            <div class="report-column" id="col-1"></div>
            <div class="report-column" id="col-2"></div>
        </div>

        <h4 style="margin: 15px 0 10px 0; font-size:0.8rem; color:var(--purple);">ğŸ“œ ìµœê·¼ ì—°ìŠµ ë‚´ì—­</h4>
        <div class="log-list" id="m-log-list"></div>
        <button class="btn btn-delete" style="width:100%; margin-top:15px;" onclick="closeModal()">ë‹«ê¸°</button>
    </div>
</div>

<script>
const group1 = ['ì•”ì‚°ì±”í”¼ì–¸', 'ë§ì…ˆì´ˆê¸‰', 'ë§ì…ˆì¤‘ê¸‰', 'ë§ì…ˆë§ˆìŠ¤í„°', '10ë§Œë“¤ê¸°', '24ë§Œë“¤ê¸°', 'ìŠíƒœí‘œ'];
const group2 = ['ê³±ì…ˆì´ˆê¸‰', 'ê³±ì…ˆì¤‘ê¸‰', 'ê³±ì…ˆë§ˆìŠ¤í„°', 'ë‚˜ëˆ—ì…ˆì´ˆê¸‰', 'ë‚˜ëˆ—ì…ˆì¤‘ê¸‰', 'ë‚˜ëˆ—ì…ˆë§ˆìŠ¤í„°'];

window.onload = function() {
    const role = localStorage.getItem('userRole');
    if (role === 'admin') {
        document.getElementById('admin-only-top').style.display = 'block';
        document.getElementById('reset-section').style.display = 'block';
    }
    updateTeacherSelects();
    displayUserList();
    loadJoinRequests();
};

function showDetail(id) {
    const users = JSON.parse(localStorage.getItem('approvedUsers') || '[]');
    const user = users.find(u => u.id === id);
    if(!user) return;

    document.getElementById('modal-user-name').innerText = `ğŸ“Š ${user.name} í•™ìƒ ë¦¬í¬íŠ¸`;
    document.getElementById('m-gem').innerText = user.gems || 0;
    document.getElementById('m-coin').innerText = user.coins || 0;
    document.getElementById('m-badges').innerText = user.badges || "ì—†ìŒ";

    const best = user.bestScores || {};
    const makeHTML = (arr) => arr.map(sub => `
        <div class="subject-card">
            <span style="color:#94a3b8; font-size:0.75rem;">${sub}</span>
            <span class="score-val">${best[sub] || '-'}</span>
        </div>
    `).join('');

    document.getElementById('col-1').innerHTML = makeHTML(group1);
    document.getElementById('col-2').innerHTML = makeHTML(group2);

    const logs = user.practiceLogs || [];
    document.getElementById('m-log-list').innerHTML = logs.length ? logs.slice().reverse().map(l => `
        <div style="display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px solid #1e293b;">
            <span style="color:#64748b;">${l.date}</span>
            <span>${l.subject}</span>
            <span style="color:var(--gold)">${l.score}</span>
        </div>
    `).join('') : "<div style='text-align:center; padding:10px;'>ë‚´ì—­ ì—†ìŒ</div>";

    document.getElementById('record-modal').style.display = 'flex';
}

function displayUserList() {
    const tableBody = document.getElementById('user-list-body');
    const users = JSON.parse(localStorage.getItem('approvedUsers') || '[]');
    const filter = document.getElementById('filter-teacher').value;
    const search = document.getElementById('search-input').value.toLowerCase();

    const filtered = users.filter(u => {
        const matchT = (filter === 'all' || u.teacher === filter || (u.name === filter && u.type === 'ì„ ìƒë‹˜'));
        const matchS = u.name.toLowerCase().includes(search) || u.id.toLowerCase().includes(search);
        return matchT && matchS;
    });

    document.getElementById('user-count').innerText = `${filtered.length}ëª…`;
    tableBody.innerHTML = filtered.map(user => `
        <tr>
            <td><strong>${user.name}</strong><br><span style="font-size:0.65rem; color:#94a3b8;">${user.id}</span></td>
            <td><button class="btn btn-blue btn-sm" onclick="showDetail('${user.id}')">ê¸°ë¡</button></td>
            <td>Lv.${user.level || 1}</td>
            <td style="font-size:0.75rem; color:var(--gold)">${user.teacher || '-'}</td>
            <td><button class="btn btn-delete btn-sm" onclick="deleteUser('${user.id}')">ì‚­ì œ</button></td>
        </tr>
    `).join('');
}

function directRegister() {
    const name = document.getElementById('reg-name').value;
    const id = document.getElementById('reg-id').value;
    const pw = document.getElementById('reg-pw').value;
    const teacher = document.getElementById('reg-teacher-select').value;
    const type = document.getElementById('reg-type').value;
    if(!name || !id || !pw) return alert("ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    const users = JSON.parse(localStorage.getItem('approvedUsers') || '[]');
    users.push({ name, id, pw, type, teacher, level: 1, gems: 0, coins: 0, bestScores: {}, badges: "", practiceLogs: [] });
    localStorage.setItem('approvedUsers', JSON.stringify(users));
    alert("ë“±ë¡ ì™„ë£Œ!");
    location.reload();
}

function deleteUser(id) { if(confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
    let users = JSON.parse(localStorage.getItem('approvedUsers') || '[]');
    users = users.filter(u => u.id !== id);
    localStorage.setItem('approvedUsers', JSON.stringify(users));
    displayUserList();
}}
function updateTeacherSelects() {
    const users = JSON.parse(localStorage.getItem('approvedUsers') || '[]');
    const teachers = users.filter(u => u.type === 'ì„ ìƒë‹˜');
    const f = document.getElementById('filter-teacher');
    const r = document.getElementById('reg-teacher-select');
    let opt = '<option value="all">ì „ì²´ë³´ê¸°</option>';
    let rOpt = '<option value="ê´€ë¦¬ì">ê´€ë¦¬ì ì§ì†</option>';
    teachers.forEach(t => { opt += `<option value="${t.name}">${t.name}</option>`; rOpt += `<option value="${t.name}">${t.name}</option>`; });
    f.innerHTML = opt; r.innerHTML = rOpt;
}
function loadJoinRequests() {
    const list = document.getElementById('request-list');
    const reqs = JSON.parse(localStorage.getItem('joinRequests') || '[]');
    list.innerHTML = reqs.length ? reqs.map((r, i) => `<div style="display:flex; justify-content:space-between; padding:8px; background:rgba(255,255,255,0.05); margin-bottom:5px; border-radius:8px;"><span>${r.name}(${r.type})</span><button class="btn btn-approve btn-sm" onclick="approveJoin(${i})">ìŠ¹ì¸</button></div>`).join('') : "ìš”ì²­ ì—†ìŒ";
}
function approveJoin(i) {
    const reqs = JSON.parse(localStorage.getItem('joinRequests') || '[]');
    const approved = JSON.parse(localStorage.getItem('approvedUsers') || '[]');
    const user = reqs[i];
    user.level=1; user.gems=0; user.coins=0; user.bestScores={}; user.badges=""; user.practiceLogs=[];
    approved.push(user);
    localStorage.setItem('approvedUsers', JSON.stringify(approved));
    reqs.splice(i, 1);
    localStorage.setItem('joinRequests', JSON.stringify(reqs));
    location.reload();
}
function resetRank(subject) {
    // 1. ì‚¬ìš©ìì—ê²Œ í™•ì¸ì°½ ë„ìš°ê¸°
    if(confirm(`${subject}ì˜ ì‹¤ì‹œê°„ ìˆœìœ„íŒ(ë­í‚¹)ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(â€» í•™ìƒë“¤ì˜ ê°œì¸ ìµœê³  ê¸°ë¡ê³¼ ì ìˆ˜ëŠ” ìœ ì§€ë©ë‹ˆë‹¤.)`)) {
        
        // 2. í•´ë‹¹ ê³¼ëª©ì˜ ìˆœìœ„ ì „ìš© ë°ì´í„°ë§Œ ì‚­ì œ
        // ê° ê²Œì„ íŒŒì¼ì—ì„œ ìˆœìœ„ë¥¼ ì €ì¥í•  ë•Œ ì‚¬ìš©í•œ í‚¤ ì´ë¦„ì„ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.
        // ì˜ˆ: 'rank_ë§ì…ˆì´ˆê¸‰', 'rank_ì•”ì‚°ì±”í”¼ì–¸' ë“±
        const rankKey = `rank_${subject}`;
        
        if(localStorage.getItem(rankKey)) {
            localStorage.removeItem(rankKey);
            alert(`${subject} ìˆœìœ„íŒì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ì œ ìƒˆë¡œìš´ ìˆœìœ„ê°€ ê¸°ë¡ë©ë‹ˆë‹¤!`);
        } else {
            alert(`í˜„ì¬ ${subject}ì— ë“±ë¡ëœ ìˆœìœ„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.`);
        }
        
        // 3. (ì„ íƒì‚¬í•­) ë§Œì•½ ê´€ë¦¬ì í™”ë©´ì—ì„œ ì‹¤ì‹œê°„ ìˆœìœ„ë¥¼ ë³´ê³  ìˆë‹¤ë©´ í™”ë©´ ê°±ì‹ 
        // if(typeof displayLiveRank === 'function') displayLiveRank();
    }
}
</script>
</body>
</html>
